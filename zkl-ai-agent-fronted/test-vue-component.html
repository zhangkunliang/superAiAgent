<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vue 组件换行符测试</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@9.0.0/marked.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .message {
            display: flex;
            margin-bottom: 24px;
            max-width: 85%;
        }
        .message-ai {
            margin-right: auto;
        }
        .message-avatar {
            flex-shrink: 0;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            margin: 0 12px;
            background-color: #007bff;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        .message-content {
            background-color: #f8f9fa;
            border-radius: 12px;
            padding: 12px 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-width: 200px;
        }
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .message-name {
            font-weight: bold;
        }
        .message-time {
            color: rgba(0, 0, 0, 0.5);
            font-size: 12px;
        }
        .message-text {
            word-break: break-word;
            line-height: 1.5;
            overflow-wrap: break-word;
        }
        .message-text code {
            background-color: #e9ecef;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
        }
        .message-text strong {
            font-weight: bold;
        }
        .message-text em {
            font-style: italic;
        }
    </style>
</head>
<body>
    <div id="app">
        <h1>Vue 组件换行符测试</h1>
        
        <div class="message message-ai">
            <div class="message-avatar">AI</div>
            <div class="message-content">
                <div class="message-header">
                    <span class="message-name">测试AI</span>
                    <span class="message-time">{{ currentTime }}</span>
                </div>
                <div class="message-text" v-html="formattedContent"></div>
            </div>
        </div>
        
        <div style="margin-top: 30px;">
            <h3>原始内容：</h3>
            <pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; white-space: pre-wrap;">{{ testContent }}</pre>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        // 配置 marked
        marked.setOptions({
            breaks: true,
            gfm: true,
            headerIds: false,
            mangle: false,
            sanitize: false
        });

        createApp({
            data() {
                return {
                    testContent: `Step 1: 工具 askZhipuAI 返回的结果："疾控监督员，即疾病预防控制监督员，是负责疾病预防控制工作监督的专业人员。他们的职责主要包括以下几个方面：\n\n1. 政策法规执行监督：监督疾病预防控制法律法规、政策、标准的执行情况，确保各项措施得到有效落实。\n\n2. 传染病防控监督：对传染病疫情报告、监测、预警、处置等环节进行监督，确保及时发现、报告、调查、控制传染病疫情。\n\n3. 公共卫生监督：对公共卫生事件、突发公共卫生事件的预防和应对工作进行监督，保障公众健康安全。\n\n4. 健康危害因素监督：对可能导致健康危害的因素（如环境污染、职业危害等）进行监督，防止健康危害的发生。\n\n5. 免疫规划监督：监督国家免疫规划的实施，确保疫苗的接种率，预防疫苗可预防的传染病。\n\n6. 健康促进监督：监督健康教育和健康促进活动，提高公众的健康意识和自我保健能力。\n\n7. 监督指导：对下级疾控机构、医疗机构、社区卫生服务中心等单位的疾病预防控制工作进行业务指导和监督。\n\n8. 信息收集与分析：收集疾病预防控制相关信息，进行数据分析，为政策制定和决策提供依据。\n\n9. 应急处理：在公共卫生事件发生时，参与应急处理工作，协助做好疫情的监测、分析、报告和处置。\n\n10. 培训与交流：组织或参与疾病预防控制相关人员的培训，提高其业务水平；与其他部门、机构进行交流合作。\n\n疾控监督员的工作对于维护公共卫生安全、保障人民群众身体健康具有重要意义。"Step 2: 思考完成 - 无需行动Step 3: 工具 doTerminate 返回的结果："任务结束"`
                }
            },
            computed: {
                currentTime() {
                    return new Date().toLocaleString('zh-CN');
                },
                formattedContent() {
                    try {
                        if (!this.testContent) return '';

                        console.log('Processing content:', this.testContent.substring(0, 100) + '...');

                        // 处理各种可能的换行符格式
                        let processedContent = this.testContent;

                        // 1. 处理转义的换行符 \\n
                        if (processedContent.includes('\\n')) {
                            console.log('Found escaped \\n, replacing...');
                            processedContent = processedContent.replace(/\\n/g, '<br>');
                        }

                        // 2. 处理真正的换行符 \n
                        if (processedContent.includes('\n')) {
                            console.log('Found real \\n, replacing...');
                            processedContent = processedContent.replace(/\n/g, '<br>');
                        }

                        // 3. 处理其他可能的换行符表示
                        if (processedContent.includes('\\r\\n')) {
                            processedContent = processedContent.replace(/\\r\\n/g, '<br>');
                        }
                        if (processedContent.includes('\\r')) {
                            processedContent = processedContent.replace(/\\r/g, '<br>');
                        }

                        // 4. 处理基本的 markdown 语法
                        const hasMarkdown = /(\*\*|__|\*|_|`|#{1,6}\s)/m.test(this.testContent);
                        if (hasMarkdown) {
                            // 处理粗体
                            processedContent = processedContent.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                            // 处理斜体（但避免与粗体冲突）
                            processedContent = processedContent.replace(/(?<!\*)\*([^*]+)\*(?!\*)/g, '<em>$1</em>');
                            // 处理行内代码
                            processedContent = processedContent.replace(/`([^`]+)`/g, '<code>$1</code>');
                        }

                        console.log('Processed content:', processedContent.substring(0, 100) + '...');
                        return processedContent;

                    } catch (error) {
                        console.error('Failed to parse content:', error);
                        // 如果处理失败，尝试所有可能的换行符替换
                        return this.testContent
                            .replace(/\\n/g, '<br>')
                            .replace(/\n/g, '<br>')
                            .replace(/\\r\\n/g, '<br>')
                            .replace(/\\r/g, '<br>');
                    }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
