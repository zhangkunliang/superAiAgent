<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>验证码测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .captcha-img {
            max-width: 200px;
            border: 1px solid #ccc;
            margin: 10px 0;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
        .log {
            background: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>验证码API测试</h1>
    
    <div class="test-section">
        <h2>测试1: 直接API调用</h2>
        <button onclick="testDirectAPI()">测试直接API调用</button>
        <div id="direct-log" class="log"></div>
    </div>
    
    <div class="test-section">
        <h2>测试2: 验证码显示</h2>
        <button onclick="loadCaptcha()">加载验证码</button>
        <button onclick="clearCaptcha()">清除验证码</button>
        <div>
            <img id="captcha-img" class="captcha-img" alt="验证码" style="display: none;">
        </div>
        <div id="captcha-log" class="log"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8123/api';
        
        function log(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
        }
        
        async function testDirectAPI() {
            const logElement = 'direct-log';
            document.getElementById(logElement).textContent = '';
            
            try {
                log(logElement, '开始测试API调用...');
                
                const response = await fetch(`${API_BASE}/auth/captcha`);
                log(logElement, `HTTP状态: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                log(logElement, `响应数据: ${JSON.stringify(data, null, 2)}`);
                
                if (data.success && data.data && data.data.captcha) {
                    log(logElement, `验证码key: ${data.data.key}`);
                    log(logElement, `验证码数据长度: ${data.data.captcha.length}`);
                    log(logElement, `验证码数据前50字符: ${data.data.captcha.substring(0, 50)}...`);
                } else {
                    log(logElement, '响应数据格式不正确');
                }
                
            } catch (error) {
                log(logElement, `错误: ${error.message}`);
                console.error('API测试错误:', error);
            }
        }
        
        async function loadCaptcha() {
            const logElement = 'captcha-log';
            const imgElement = document.getElementById('captcha-img');
            
            document.getElementById(logElement).textContent = '';
            imgElement.style.display = 'none';
            
            try {
                log(logElement, '加载验证码...');
                
                const response = await fetch(`${API_BASE}/auth/captcha`);
                const data = await response.json();
                
                if (data.success && data.data && data.data.captcha) {
                    let imageSrc = data.data.captcha;
                    
                    // 检查是否需要添加data URL前缀
                    if (!imageSrc.startsWith('data:image/')) {
                        imageSrc = `data:image/png;base64,${imageSrc}`;
                    }
                    
                    log(logElement, `设置图片源: ${imageSrc.substring(0, 50)}...`);
                    
                    imgElement.src = imageSrc;
                    imgElement.style.display = 'block';
                    
                    imgElement.onload = () => {
                        log(logElement, '验证码图片加载成功');
                    };
                    
                    imgElement.onerror = (error) => {
                        log(logElement, `验证码图片加载失败: ${error.message || '未知错误'}`);
                    };
                    
                } else {
                    log(logElement, '验证码数据无效');
                }
                
            } catch (error) {
                log(logElement, `加载验证码失败: ${error.message}`);
            }
        }
        
        function clearCaptcha() {
            document.getElementById('captcha-img').style.display = 'none';
            document.getElementById('captcha-log').textContent = '';
        }
    </script>
</body>
</html>